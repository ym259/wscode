
import { NextRequest, NextResponse } from 'next/server';
import OpenAI from 'openai';

// Lazy initialization to avoid build-time errors when env var is not set
let openaiClient: OpenAI | null = null;

function getOpenAI(): OpenAI {
    if (!openaiClient) {
        const apiKey = process.env.OPENAI_API_KEY;
        if (!apiKey) {
            throw new Error('OPENAI_API_KEY environment variable is not set');
        }
        openaiClient = new OpenAI({ apiKey });
    }
    return openaiClient;
}

export async function POST(req: NextRequest) {
    try {
        const body = await req.json();
        console.log('[API/AI] Request body:', JSON.stringify(body, null, 2));
        const { prompt, context, messages } = body;

        // SuperDoc AI Actions sends messages array, our simple UI sends prompt
        const userPrompt = prompt || messages?.[messages.length - 1]?.content;

        if (!userPrompt) {
            console.error('[API/AI] No prompt or messages found in request');
            return NextResponse.json({ error: 'Prompt is required' }, { status: 400 });
        }

        console.log('[API/AI] Final userPrompt:', userPrompt);

        const openai = getOpenAI();

        let apiMessages = [];

        // If messages are provided (e.g. from SuperDoc Planner), use them directly
        if (messages && Array.isArray(messages) && messages.length > 0) {
            console.log('[API/AI] Using provided messages array');
            apiMessages = messages;
        } else {
            // Otherwise construct default message structure for simple prompts
            console.log('[API/AI] Constructing default messages');
            const systemPrompt = `You are an intelligent writing assistant embedded in a document editor.
Your task is to help the user edit, write, or improve their document.

Context from the document:
${context || 'No context provided.'}

Instructions:
- You are an agent capable of editing the document.
- Use the provided functions/tools to modify the document as requested.
- Improve the text, fix grammar, or insert new content as needed.
`;
            apiMessages = [
                { role: 'system', content: systemPrompt },
                { role: 'user', content: userPrompt }
            ];
        }

        const completion = await openai.chat.completions.create({
            model: 'gpt-5-mini',
            messages: apiMessages,
            // temperature: 0.7,
        });

        const content = completion.choices[0].message.content;

        return NextResponse.json({ content });
    } catch (error) {
        console.error('AI API Error:', error);
        const message = error instanceof Error ? error.message : 'Internal Server Error';
        return NextResponse.json({ error: message }, { status: 500 });
    }
}
